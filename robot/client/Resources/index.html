<!--python -m SimpleHTTPServer 80-->
<html>
<head>
  <meta charset="utf-8">
  <style>
     .opacity_img {
      opacity: 0.45;
     }

     .opacity_img:active {
      cursor: pointer;
      opacity: 1.0;
     }

     .progress_bar {
      position: relative;
      width: 45%;
      height: 10px;
      background-color: black;
    }

    .speed_bar {
      position: absolute;
      width: 10%;
      height: 100%;
      background-color: red;
    }
  </style>
</head>

<body>
  <canvas style="position:absolute; left:20; bottom:10;" id="canvas" width="118" height="128"></canvas>
  <input class="opacity_img" type="image" src="img/gas.png" id="accelerate" style="position:absolute; outline: none; right:5; bottom:110; border-radius:100%;" ontouchstart="acc_begin();" ontouchend="acc_end()" ontouchcancel="acc_end()" ontouchleave="acc_end()" />
  <input class="opacity_img" type="image" src="img/break.png" id="break" style="position:absolute; outline: none; right:5; bottom:5; border-radius:100%;" ontouchstart="stop();" />
  <input type="image" src="img/camera.png" id="camera" style="position:absolute; outline: none; width:50; height:50; right:70; top:30;" onclick="camera();" />
  <input class="opacity_img" type="image" src="img/refresh.png" id="refresh" style="position:absolute; outline: none; width:50; height:50; right:10; top:30;" ontouchstart="refresh();" onclick="refresh();" />

  <input style="position:absolute; transform: rotate(-270deg); transform: scale(2); outline: none; left:15; top:55;" type="radio" id="gear_2" name="gear" onchange="max_speed = 100;"/><label style="position:absolute; outline: none; left:50; top:57;" for="gear_2">2</label>
  <input style="position:absolute; transform: rotate(-270deg); transform: scale(2); outline: none; left:15; top:115;" type="radio" id="gear_1" name="gear" checked="checked" onchange="max_speed = 75;" /><label style="position:absolute; outline: none; left:50; top:117;" for="gear_1">1</label>
  <input style="position:absolute; transform: rotate(-270deg); transform: scale(2); outline: none; left:15; top:175;" type="radio" id="gear_R" name="gear" onchange="max_speed = -60;"/><label style="position:absolute; outline: none; left:50; top:177;" for="gear_R">R</label>

  <div class="progress_bar" style="position:absolute; left:10; top:10;"><div class="speed_bar" id="left_engine_speed_bar" style="width:0;"></div></div>
  <div class="progress_bar" style="position:absolute; right:10; top:10;"><div class="speed_bar" id="right_engine_speed_bar" style="width:0;"></div></div>
  <iframe id="stream"  width="100%" height="95%" frameBorder="0"></iframe>

  <script type="text/javascript">
    const speed_step = 20;
    const turn_step = 2;
    const update_interval = 10;
    const url = "http://192.168.1.71";
    const stream_port = 10088;
    const TO_RADIANS = Math.PI / 180;

    var max_speed = 75;
    var left = 0;
    var right = 0;
    var left_speed = 0;
    var old_left_speed = 0;
    var right_speed = 0;
    var old_right_speed = 0;
    var angle = 0;
    var inter = 0;
    var requests = [];
    var steering_wheel_image = new Image();
    var once = true;
    var abort = false;

    init();

    function max_turn() {
      return Math.abs(max_speed);
    }

    function update_speed(left, right, a) {
      abort_all();

      var angle = a * turn_step;
      if (angle >= 0 && angle < max_turn()) { // left
        left_speed = scale(left, 0, Math.max(0, Math.abs(max_speed) - angle));
      } else {
        left_speed = scale(left, 0, Math.abs(max_speed));
      }

      if (angle < 0 || angle > max_turn()) { // right
        const tmp_angle = angle < 0 ? -angle : (angle > 360 ? 720 - angle : 360 - angle);
        right_speed = scale(right, 0, Math.max(0, Math.abs(max_speed) - tmp_angle));
      } else {
        right_speed = scale(right, 0, Math.abs(max_speed));
      }

      if (left_speed != old_left_speed || right_speed != old_left_speed) {
          document.getElementById("left_engine_speed_bar").style.width = left_speed + "%";
          document.getElementById("right_engine_speed_bar").style.width = right_speed + "%";
          request(url + "/" + (max_speed < 0 ? "reverse" : "forward") + ":" + left_speed + ":" + right_speed, true);
      }

      old_left_speed = left_speed;
      old_right_speed = right_speed;
    }

    function acc_begin() {
      if (!abort) {
        inter = setInterval(accelerate, update_interval);
      }
    }

    function acc_end() {
      clearInterval(inter);
      stop();
    }

    function accelerate() {
      left += speed_step; right += speed_step;
      if (left > Math.abs(max_speed)) left = Math.abs(max_speed);
      if (right > Math.abs(max_speed)) right = Math.abs(max_speed);
      update_speed(left, right, angle);
    }

    function stop() {
      left = 0
      right = 0
      update_speed(left, right, angle);
    }

    function scale(value, min, max) {
        var baseMin = 0;
        var baseMax = Math.abs(max_speed);
        return Math.round(((max - min) * (value - baseMin) / (baseMax - baseMin)) + min);
    }

    function refresh() {
      window.location.reload();
    }

    function camera() {
      var elem = document.getElementById('camera');
      elem.style.opacity = elem.style.opacity == 1.0 ? 0.5 : 1.0;

      if (elem.style.opacity == 1.0) {
        document.getElementById('stream').style.display = 'block';
        document.getElementById('stream').src = url + ":" + stream_port + "/?action=stream";
        request(url + "/camera:on", true);
      } else {
        document.getElementById('stream').style.display = 'none';
        document.getElementById('stream').src = "";
        request(url + "/camera:off", true);
      }
    }

    function is_angle_allowed(value) {
      value *= turn_step + 4;
      const tmp = value <= 0 ? value : (value > 360 ? value - 720 : (value > max_turn() ? value - 360 : value));
      return tmp > -max_turn() && tmp < max_turn();
    }

    function update_gear(value) {
      var gears = document.getElementsByName('gear');
      for (var i = 0, length = gears.length; i < length; i++) {
          if (gears[i].checked && gears[i - value]) {
            gears[i - value].checked = true;
            gears[i - value].onchange();
            break;
          }
      }
    }

    function update_angle(value) {
      if (is_angle_allowed(angle + value)) {
        angle += value;
        rotate_steering_wheel(angle);
        update_speed(left, right, angle);
      }
    }

    function init() {
      if (once) {
        request(url + "/forward:0:0", true); // stop
        request(url + "/camera:off", true);

        document.getElementById('camera').style.opacity = 0.5;
        steering_wheel_image.src ="img/sw.png";

        document.onkeydown = function (event) {
          event = event || window.event;
          switch (event.key) {
            case "Up": case "ArrowUp": accelerate(); break;
            case "Left": case "ArrowLeft": update_angle(+turn_step); break;
            case "Right": case "ArrowRight": update_angle(-turn_step); break;
            case "Down": case "ArrowDown": stop(); break;
            case "PageUp": update_gear(+1); break;
            case "PageDown": update_gear(-1); break;
          }
        };

        document.onkeyup = function (event) {
          event = event || window.event;
          switch (event.key) {
            case "Up": case "ArrowUp": stop(); break;
          }
        };

        window.oncontextmenu = function(event) {
             event.preventDefault();
             event.stopPropagation();
             return false;
        };

        if (window.DeviceOrientationEvent) {
          window.addEventListener('deviceorientation', function(event) {
            rotate_steering_wheel(event.alpha);
          }, true);
        }

        rotate_steering_wheel(0);
        once = false;
      }
    }

    function rotate_steering_wheel(orientation) {
      if (is_angle_allowed(orientation)) {
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        draw_rotated_image(ctx, steering_wheel_image, steering_wheel_image.width / 2, steering_wheel_image.height / 2, -orientation * turn_step);
        angle = Math.round(orientation);
      }
    }

    function draw_rotated_image(context, image, x, y, angle) {
      context.save();
      context.translate(x, y);
      context.rotate(angle * TO_RADIANS);
      context.drawImage(image, -(image.width / 2), -(image.height / 2));
      context.restore();
    }

    function request(url, async) {
        var xmlHttp = new XMLHttpRequest();
        requests.push(xmlHttp);
        xmlHttp.open("GET", url, async);
        xmlHttp.send(null);
    }

    function abort_all() {
      abort = true;

      for (i = 0; i < inter; ++i) {
        clearInterval(i);
      }

      for (i = 0; i < requests.length; ++i) {
        requests[i].abort();
      }

      requests = [];
      abort = false;
    }
    </script>
</body>
</html>
