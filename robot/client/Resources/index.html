<!--python -m SimpleHTTPServer 80-->
<html>
<head>
  <meta charset="utf-8">
  <style>
     .opacity_img {
      opacity: 0.45;
     }

     .opacity_img:active {
      cursor: pointer;
      opacity: 1.0;
     }

     .progress_bar {
      position: relative;
      width: 45%;
      height: 10px;
      background-color: black;
    }

    .speed_bar {
      position: absolute;
      width: 10%;
      height: 100%;
      background-color: red;
    }

    .sidenav {
        height: 100%; /* 100% Full-height */
        width: 0; /* 0 width - change this with JavaScript */
        position: fixed; /* Stay in place */
        z-index: 1; /* Stay on top */
        top: 0;
        left: 0;
        background-color: #111; /* Black*/
        overflow-x: hidden; /* Disable horizontal scroll */
        padding-top: 60px; /* Place content 60px from the top */
        transition: 0.5s; /* 0.5 second transition effect to slide in the sidenav */
    }

    .sidenav a {
        padding: 8px 8px 8px 32px;
        text-decoration: none;
        font-size: 25px;
        color: #818181;
        display: block;
        transition: 0.3s
    }

    .sidenav a:hover, .offcanvas a:focus{
        color: #f1f1f1;
    }

    .closebtn {
        position: absolute;
        top: 0;
        right: 25px;
        font-size: 36px !important;
        margin-left: 50px;
    }
  </style>
</head>

<body>
  <canvas style="position:absolute; left:20; bottom:10;" id="canvas" width="118" height="128"></canvas>
  <input class="opacity_img" type="image" src="img/gas.png" id="accelerate" style="position:absolute; outline: none; right:5; bottom:110; border-radius:100%;" ontouchstart="acc_begin();" ontouchend="acc_end()" ontouchcancel="acc_end()" ontouchleave="acc_end()" />
  <input class="opacity_img" type="image" src="img/break.png" id="break" style="position:absolute; outline: none; right:5; bottom:5; border-radius:100%;" ontouchstart="stop();" />
  <input type="image" src="img/camera.png" id="camera" style="position:absolute; outline: none; width:50; height:50; right:70; top:30;" onclick="camera();" />
  <input class="opacity_img" type="image" src="img/refresh.png" id="refresh" style="position:absolute; outline: none; width:50; height:50; right:10; top:30;" ontouchstart="refresh();" onclick="refresh();" />
  <input type="image" src="img/gears.png" style="position:absolute; outline: none; left:13; top:127;" />
  <input style="position:absolute; transform: rotate(-270deg); transform: scale(2); outline: none; left:49; top:175;" type="radio" id="gear_2" name="gear" onchange="max_speed = 100;"/>
  <input style="position:absolute; transform: rotate(-270deg); transform: scale(2); outline: none; left:49; top:122;" type="radio" id="gear_1" name="gear" checked="checked" onchange="max_speed = 75;" />
  <input style="position:absolute; transform: rotate(-270deg); transform: scale(2); outline: none; left:11; top:122;" type="radio" id="gear_R" name="gear" onchange="max_speed = -60;"/>
  <div class="progress_bar" style="position:absolute; left:10; top:10;"><div class="speed_bar" id="left_engine_speed_bar" style="width:0;"></div></div>
  <div class="progress_bar" style="position:absolute; right:10; top:10;"><div class="speed_bar" id="right_engine_speed_bar" style="width:0;"></div></div>
  <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="close_nav();">&times;</a>
    <label style="margin:30; color:white;" for="ip">Camera: 'http://address:port'</label>
    <input id="camera_address" style="margin-left:30; margin-top:5; width:200px;" type="text" maxlength="512" onchange="save_item('camera_address', this.value);" />
    <hr />
    <a href="javascript:void(0)" onclick="request(url + '/off', true); close_nav();">Shut Down</a>
    <hr />
  </div>
  <input type="image" src="img/menu.png" style="position:absolute; outline: none; width:50; height:50; left:10; top:30;" onclick="open_nav();" />
  <iframe id="stream"  width="100%" height="95%" frameBorder="0"></iframe>

  <script type="text/javascript">
    const speed_step = 20;
    const turn_step = 1;
    const max_turn_offset = 4;
    const update_interval = 10;
    const default_camera_address = "http://192.168.1.71:10088";
    const TO_RADIANS = Math.PI / 180;

    var max_speed = 75;
    var left = 0;
    var right = 0;
    var left_speed = 0;
    var old_left_speed = 0;
    var right_speed = 0;
    var old_right_speed = 0;
    var isFirstTime = true;
    var alpha = 0;
    var alphaOffset = 0;
    var inter = 0;
    var requests = [];
    var steering_wheel_image = new Image();
    var once = true;
    var abort = false;
    var cameraTimeout = 0;
    var url = default_camera_address.substr(0, default_camera_address.lastIndexOf(':'));
    var port = default_camera_address.substr(default_camera_address.lastIndexOf(':') + 1);

    init();

    function max_turn() {
      return Math.abs(max_speed) - max_turn_offset;
    }

    function update_speed(left, right, value) {
      abort_all();

      var alpha = value * turn_step;
      left_speed = scale(left, 0, Math.max(0, Math.abs(max_speed) - (alpha > 0 ? Math.min(alpha, max_turn()) : 0)));
      right_speed = scale(right, 0, Math.max(0, Math.abs(max_speed) + (alpha < 0 ? Math.max(alpha, -max_turn()) : 0)));

      if (old_left_speed != left_speed || old_right_speed != right_speed) {
          document.getElementById("left_engine_speed_bar").style.width = left_speed + "%";
          document.getElementById("right_engine_speed_bar").style.width = right_speed + "%";
          request(url + "/" + (max_speed < 0 ? "reverse" : "forward") + ":" + left_speed + ":" + right_speed, true);
          old_left_speed = left_speed;
          old_right_speed = right_speed;
      }
    }

    function acc_begin() {
      if (!abort) {
        inter = setInterval(accelerate, update_interval);
      }
    }

    function acc_end() {
      clearInterval(inter);
      stop();
    }

    function accelerate() {
      left += speed_step; right += speed_step;
      left = Math.min(left, Math.abs(max_speed));
      right = Math.min(right, Math.abs(max_speed));
      update_speed(left, right, alpha);
    }

    function stop() {
      left = 0
      right = 0
      update_speed(left, right, alpha);
    }

    function scale(value, min, max) {
        var baseMin = 0;
        var baseMax = Math.abs(max_speed);
        return Math.round(((max - min) * (value - baseMin) / (baseMax - baseMin)) + min);
    }

    function refresh() {
      window.location.reload();
    }

    function camera() {
      var elem = document.getElementById('camera');
      elem.style.opacity = elem.style.opacity == 1.0 ? 0.5 : 1.0;

      if (elem.style.opacity == 1.0) {
        document.getElementById('stream').style.display = 'block';
        cameraTimeout = setTimeout(function() { document.getElementById('stream').src = url + ":" + port + "/?action=stream"; }, 1000);
        localStorage.setItem('camera_is_on', '');
        request(url + "/camera:on", true);
      } else {
        clearTimeout(cameraTimeout);
        document.getElementById('stream').style.display = 'none';
        document.getElementById('stream').src = "";
        localStorage.removeItem('camera_is_on');
        request(url + "/camera:off", true);
      }
    }

    function is_alpha_allowed(value) {
      value *= turn_step;
      return value > -max_turn() && value < max_turn();
    }

    function update_gear(value) {
      var gears = document.getElementsByName('gear');
      for (var i = 0, length = gears.length; i < length; i++) {
          if (gears[i].checked && gears[i - value]) {
            gears[i - value].checked = true;
            gears[i - value].onchange();
            break;
          }
      }
    }

    function update_alpha(value) {
      if (is_alpha_allowed(alpha + value)) {
        alpha += value;
        rotate_steering_wheel(alpha);
        update_speed(left, right, alpha);
      }
    }

    function init() {
      if (once) {
        var camera_address = localStorage.getItem('camera_address');
        if (camera_address == null) {
          camera_address = default_camera_address;
        }

        url = camera_address.substr(0, camera_address.lastIndexOf(':'));
        port = camera_address.substr(camera_address.lastIndexOf(':') + 1);

        document.getElementById("camera_address").value = url + ":" + port;
        steering_wheel_image.src = "img/sw.png";

        document.onkeydown = function (event) {
          event = event || window.event;
          switch (event.key) {
            case "Up": case "ArrowUp": accelerate(); break;
            case "Left": case "ArrowLeft": update_alpha(+turn_step * 4); break;
            case "Right": case "ArrowRight": update_alpha(-turn_step * 4); break;
            case "Down": case "ArrowDown": stop(); break;
            case "PageUp": update_gear(+1); break;
            case "PageDown": update_gear(-1); break;
          }
        };

        document.onkeyup = function (event) {
          event = event || window.event;
          switch (event.key) {
            case "Up": case "ArrowUp": stop(); break;
          }
        };

        window.oncontextmenu = function(event) {
           event.preventDefault();
           event.stopPropagation();
           return false;
        };

        if (window.DeviceOrientationEvent) {
          window.addEventListener('deviceorientation', function(event) {
            alpha = event.alpha > 360 ? event.alpha - 720 : (event.alpha > 180 ? event.alpha - 360 : event.alpha);
            rotate_steering_wheel(alpha);
          }, false);
        }

        rotate_steering_wheel(0);

        if (localStorage.getItem('camera_is_on') != null) {
          document.getElementById('stream').style.display = 'block';
          document.getElementById('stream').src = url + ":" + port + "/?action=stream";
          document.getElementById('camera').style.opacity = 1.0;
        } else {
          document.getElementById('camera').style.opacity = 0.5;
          request(url + "/camera:off", true);
        }

        request(url + "/forward:0:0", true); // stop
        once = false;
      }
    }

    function rotate_steering_wheel(value) {
      if (is_alpha_allowed(value)) {
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        draw_rotated_image(ctx, steering_wheel_image, steering_wheel_image.width / 2, steering_wheel_image.height / 2, -value * turn_step);
      }
    }

    function draw_rotated_image(context, image, x, y, alpha) {
      context.save();
      context.translate(x, y);
      context.rotate(alpha * TO_RADIANS);
      context.drawImage(image, -(image.width / 2), -(image.height / 2));
      context.restore();
    }

    function request(url, async) {
        var xmlHttp = new XMLHttpRequest();
        requests.push(xmlHttp);
        xmlHttp.open("GET", url, async);
        xmlHttp.send(null);
    }

    function abort_all() {
      abort = true;

      for (i = 0; i < inter; ++i) {
        clearInterval(i);
      }

      for (i = 0; i < requests.length; ++i) {
        requests[i].abort();
      }

      requests = [];
      abort = false;
    }

    function open_nav() {
      document.getElementById("mySidenav").style.width = "250px";
      document.body.style.backgroundColor = "rgba(0,0,0,0.4)";
    }

    function close_nav() {
      document.getElementById("mySidenav").style.width = "0";
      document.body.style.backgroundColor = "white";
    }

    function save_item(item, value) {
      if (value == "") {
        localStorage.removeItem(item);
      } else {
        localStorage.setItem(item, value);
      }
    }
    </script>
</body>
</html>
