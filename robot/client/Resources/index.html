<!--python -m SimpleHTTPServer 80-->
<html>
<head>
  <meta charset="utf-8">
  <style>
     .opacity_img{
      opacity: 0.45;
     }

     .opacity_img:active{
      cursor: pointer;
      opacity: 1.0;
     }

     .progress_bar {
      position: relative;
      width: 45%;
      height: 10px;
      background-color: black;
    }

    .speed_bar {
      position: absolute;
      width: 10%;
      height: 100%;
      background-color: red;
    }
  </style>
</head>

<body>
  <canvas style="position:absolute; left:20; bottom:10;" id="canvas" width="118" height="128"></canvas>
  <input class="opacity_img" type="image" src="gas.png" id="accelerate" style="position:absolute; outline: none; right:25; bottom:130; border-radius:100%;" ontouchstart="acc_begin();" ontouchend="acc_end()" ontouchcancel="acc_end()" ontouchleave="acc_end()" />
  <input class="opacity_img" type="image" src="break.png" id="break" style="position:absolute; outline: none; right:25; bottom:15; border-radius:100%;" ontouchstart="stop();" />
  <input class="opacity_img" type="image" src="refresh.png" id="refresh" style="position:absolute; outline: none; width:50; height:50; right:5; top:30;" ontouchstart="refresh();" onclick="refresh();" />
  <input style="position:absolute; transform: rotate(-270deg); outline: none; width:140; left:-55; top:115; border-radius:100%;" type="range" id="max_speed" min="0" max="2" value="0" step="1" onchange="gear(this.value)" />
  <div style="position:absolute; outline: none; left:35; top:55;">2</div>
  <div style="position:absolute; outline: none; left:35; top:115;">1</div>
  <div style="position:absolute; outline: none; left:35; top:175;">R</div>
  <div class="progress_bar" style="position:absolute; left:10; top:10;"><div class="speed_bar" id="left_engine_speed_bar" style="width:0;"></div></div>
  <div class="progress_bar" style="position:absolute; right:10; top:10;"><div class="speed_bar" id="right_engine_speed_bar" style="width:0;"></div></div>
  <iframe src="http://192.168.1.71:10088/?action=stream" width="100%" height="100%" frameBorder="0"></iframe>

  <p style="position:absolute; left:20; top:12; color:blue;" id="debug"></p>

  <script type="text/javascript">
    var max_speed = 100;
    var speed_step = 20;
    var turn_step = 2;
    var update_interval = 10;

    var TO_RADIANS = Math.PI / 180;
    var left = 0;
    var right = 0;
    var left_speed = 0;
    var old_left_speed = 0;
    var right_speed = 0;
    var old_right_speed = 0;
    var angle = 0;
    var inter = 0;
    var requests = [];
    var steering_wheel_image = new Image();

    init();

    function gear(value) {
      switch(value) {
        case "0": max_speed = 100; break; // 2
        case "1": max_speed = 75; break; // 1
        case "2": max_speed = -50; break; // R
      }
    }

    function update_speed(left, right, a) {
      var angle = a * turn_step;
      if (angle >= 0 && angle < 100) { // left
        left_speed = scale(left, 0, Math.max(0, Math.abs(max_speed) - angle));
      } else {
        left_speed = scale(left, 0, Math.abs(max_speed));
      }

      if (angle > 200 || angle < 0) { // right
        var tmp_angle = angle < 0 ? -angle : (angle > 360 ? 720 - angle : 360 - angle);
      document.getElementById("debug").innerHTML = tmp_angle;
        right_speed = scale(right, 0, Math.max(0, Math.abs(max_speed) - tmp_angle));
      } else {
        right_speed = scale(right, 0, Math.abs(max_speed));
      }

      document.getElementById("left_engine_speed_bar").style.width = left_speed + "%";
      document.getElementById("right_engine_speed_bar").style.width = right_speed + "%";


      abort_all();
      if (left_speed != old_left_speed || right_speed != old_left_speed) {
          request("http://192.168.1.71/" + (max_speed < 0 ? "reverse" : "forward") + ":" + left_speed + ":" + right_speed, true);
      }
      old_left_speed = left_speed;
      old_right_speed = right_speed;
    }

    function acc_begin() {
      inter = setInterval(accelerate, update_interval);
    }

    function acc_end() {
      clearInterval(inter);
      stop();
    }

    function accelerate() {
      left += speed_step; right += speed_step;
      if (left > Math.abs(max_speed)) left = Math.abs(max_speed);
      if (right > Math.abs(max_speed)) right = Math.abs(max_speed);
      update_speed(left, right, angle);
    }

    function stop() {
      left = 0
      right = 0
      update_speed(left, right, angle);
    }

    function scale(value, min, max) {
        var baseMin = 0;
        var baseMax = Math.abs(max_speed);
        return Math.round(((max - min) * (value - baseMin) / (baseMax - baseMin)) + min);
    }

    function refresh() {
      window.location.reload();
    }

    function init() {
      steering_wheel_image.src ="sw.png";

      document.onkeydown = function (event) {
        event = event || window.event;
        switch (event.key) {
          case "Up": accelerate(); break;
          case "Left": ++angle; rotateSteeringWheel(angle); update_speed(left, right, angle); break;
          case "Right": --angle; rotateSteeringWheel(angle); update_speed(left, right, angle); break;
          case "Down": stop(); break;
          case "PageUp": --document.getElementById("max_speed").value; gear(document.getElementById("max_speed").value); break;
          case "PageDown": ++document.getElementById("max_speed").value; gear(document.getElementById("max_speed").value); break;
        }
      };

      document.onkeyup = function (event) {
        event = event || window.event;
        switch (event.key) {
          case "Up": stop(); break;
        }
      };

      window.oncontextmenu = function(event) {
           event.preventDefault();
           event.stopPropagation();
           return false;
      };

      if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', function(event) {
          rotateSteeringWheel(event.accelerationIncludingGravity.alpha);
        }, true);
      }

      rotateSteeringWheel(0);
    }

    function rotateSteeringWheel(orientation) {
      var canvas = document.getElementById('canvas');
      var ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawRotatedImage(ctx, steering_wheel_image, 118/2, 128/2, -orientation * turn_step);
      angle = Math.round(orientation);
    }

    function drawRotatedImage(context, image, x, y, angle) {
      context.save();
      context.translate(x, y);
      context.rotate(angle * TO_RADIANS);
      context.drawImage(image, -(image.width / 2), -(image.height / 2));
      context.restore();
    }

    function request(url, async) {
        var xmlHttp = new XMLHttpRequest();
        requests.push(xmlHttp);
        xmlHttp.open("GET", url, async);
        xmlHttp.send(null);
    }

    function abort_all() {
      for (i = 0; i < requests.length; ++i) {
        requests[i].abort();
      }
      requests = [];
    }
    </script>
</body>
</html>
